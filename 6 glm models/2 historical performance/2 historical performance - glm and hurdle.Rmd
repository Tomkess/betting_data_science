---
title: "1 model development"
author: "Ing. Peter Tomko, M.A."
date: "1/9/2020"
output:
  pdf_document: default
  html_document: default
subtitle: GLM model with Poisson Distribution & Hurdle Model with Binomial Distribution
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidymodels)
library(pscl)
library(xlsx)

# ----- Specify Output Path -----
proj_path <- "C:/Users/Peter/Desktop/ds_projects/betting_data_science"
folder_path <- "6 glm models/1 model development/preliminary_data"
hist_path <- "6 glm models/2 historical performance"
excel_output <- "evaluation_Data.xlsx"
file_path <- "1b elastic net modelling.RData"

output_file <- paste(proj_path, "/", hist_path, "/", excel_output, sep ="")
input_path <- paste(proj_path, "/", folder_path, "/", file_path, sep = "")

rm(proj_path)
rm(folder_path)
rm(file_path)
rm(excel_output)
rm(hist_path)

load(input_path)
```

```{r connection, warning = F, message = F, error = F}
con <- DBI::dbConnect(odbc::odbc(), "betting_ds", bigint = "integer")
```

```{sql Match Stats, connection = con, output.var = "t_match_stats"}
select * from t_match_stats;
```

## Model Estimation

Two approaches are compared in this place, namely GLM model with Poisson Distribution and hurdle model. The latter one is set with logit link function and binomial distribution - i.e. firstly the logit is estimated to predict if the the team scores and if the team scores the second part consists of Poisson distribution. It means that the special distribution is concerned when the team does not score.

```{r Model GLM}
model_vars <- c(unique(var_importance$data$Variable), "is_home", "n_goals")
master_data <- master_data %>%
  group_by(data_type) %>%
  mutate(glm_data = 
           map(binned_data, 
               function(i_data){
                 i_data %>%
                   select(one_of(model_vars)) %>%
                   mutate(is_home = ifelse(is_home == 1, "yes", "no")) %>%
                   rename_all(~stringr::str_replace_all(., "__", "_")) %>%
                   rename_all(~stringr::str_replace_all(., "woe.", "")) %>%
                   rename_all(~stringr::str_replace_all(., ".binned", "")) %>%
                   as.data.frame()
               }))

# - calculate full model
glm_model <- 
  glm(n_goals ~ ., 
      family = "poisson", 
      data = master_data %>%
        filter(data_type %in% "Train") %>%
        select(data_type, glm_data) %>%
        unnest(c(glm_data)) %>%
        as.data.frame() %>%
        select(-data_type))

# - select only subset of variables based on VIF
vif_glm_model <- data.frame("vif" = car::vif(glm_model))
final_vars <- rownames(vif_glm_model %>% filter(vif <= 5))
model_data <- 
  master_data %>%
  filter(data_type %in% "Train") %>%
  select(data_type, glm_data) %>%
  unnest(c(glm_data)) %>%
  as.data.frame() %>%
  select(-data_type) %>%
  select(n_goals, one_of(final_vars))

# - estimate final models
glm_m_final <- glm(n_goals ~ ., family = "poisson", data = model_data)

hurdle_model <- hurdle(n_goals ~ ., dist = "poisson", 
                       link = "logit", zero.dist = "binomial", 
                       data = model_data)
```

### Summary of GLM Model

```{r echo = FALSE}
print(summary(glm_m_final))
```

### Summary of Hurdle Model

```{r echo = FALSE}
print(summary(hurdle_model))
```

```{r Prepare Data, echo = F, error = F, message = F, warning = F}
master_data <- 
  master_data %>%
  group_by(data_type) %>%
  
  # - Apply Model
  mutate(pred_data = 
           map(glm_data, function(i_data){
             data.frame(glm_pred = 
                          predict(glm_m_final, 
                                  newdata = i_data, 
                                  type = "response"),
                        hurdle_pred = predict(hurdle_model, 
                                              newdata = i_data, 
                                              type = "response"))
           }))

eval_dataset <-
  master_data %>%
  
  # - keep prediction and variables
  select(-binned_data, -glm_data) %>%
  unnest(c(data, pred_data)) %>%
  as.data.frame() %>%
  select(data_type, league, team, is_home, season, created_at, 
         match_id, n_goals, glm_pred, hurdle_pred) %>%
  gather(., model_name, est_value, 
         -data_type, -league, -team, -is_home, -season, -created_at, 
         -match_id, -n_goals) %>%
  as.data.frame() %>%
  
  # - categorize data
  mutate(m_pred = ifelse(is.na(est_value), "Missing Prediction", "OK")) %>%
  as.data.frame() %>%
  mutate(is_home = ifelse(is_home == 1, "HomeTeam", "AwayTeam")) %>%
  
  group_by(data_type, league, season, created_at, match_id, model_name) %>%
  mutate(total_goals = sum(n_goals)) %>%
  select(-n_goals) %>%
  as.data.frame() %>%
  mutate(var_home = ifelse(is_home == "HomeTeam", "HTL", "ATL")) %>%
  group_by(data_type, league, season, created_at, match_id, 
           model_name, total_goals, m_pred) %>%
  nest() %>%
  rename(d_match = data) %>%
  
  # - does team has opponent?
  mutate(second_match = 
           map(d_match, 
               function(i_data) 
                 data.frame("status" = 
                              ifelse(nrow(i_data) != 2, 
                                     "Second Team Not Found", "OK")))) %>%
  unnest(c(second_match)) %>%
  
  # - get match characteristics
  filter(m_pred == "OK" & status == "OK") %>%
  group_by(m_pred, data_type, league, season, created_at, 
           match_id, model_name, total_goals) %>%
  mutate(match_result = map(d_match, function(i_data){
    
    data.frame("HomeTeam" = i_data$team[i_data$is_home %in% "HomeTeam"],
               "AwayTeam" = i_data$team[i_data$is_home %in% "AwayTeam"],
               "HTL" = i_data$est_value[i_data$is_home %in% "HomeTeam"],
               "ATL" = i_data$est_value[i_data$is_home %in% "AwayTeam"])
    
  })) %>%
  select(-d_match) %>%
  unnest(c(match_result)) %>%
  as.data.frame() %>%
  
  select(-m_pred, -status) %>%
  as.data.frame() %>%
  
  # - get probabilities
  mutate(prob_under = dpois(0, HTL) * dpois(0, ATL) +
           dpois(0, HTL) * dpois(1, ATL) +
           dpois(0, HTL) * dpois(2, ATL) +
           
           dpois(1, HTL) * dpois(0, ATL) +
           dpois(2, HTL) * dpois(0, ATL) +
           dpois(1, HTL) * dpois(1, ATL)) %>%
  mutate(prob_over = 1 - prob_under) %>%
  mutate(pred_res = ifelse(prob_over > prob_under, "Over 2.5", "Under 2.5"),
         pred_prob = ifelse(prob_over > prob_under, prob_over, prob_under)) %>%
  as.data.frame() %>%
  
  # - get actual odds by bookmakers
  left_join(., t_match_stats %>% 
              select(season, league, created_at, 
                     match_id, `b365.2.5`, `b365.2.5.1`, 
                     `p.2.5`, `p.2.5.1`, `gb.2.5`, `gb.2.5.1`) %>%
              distinct()) %>%
  as.data.frame() %>%
  rowwise() %>%
  mutate(odds_25 = coalesce(`b365.2.5`, `p.2.5`, `gb.2.5`),
         odds_251 = coalesce(`b365.2.5.1`, `p.2.5.1`, `gb.2.5.1`)) %>%
  select(-`b365.2.5`, -`b365.2.5.1`, -`p.2.5`, 
         -`p.2.5.1`, -`gb.2.5`, -`gb.2.5.1`)

eval_masterdata <- eval_dataset %>%
  crossing(., expand.grid("min_kelly" = c(0.05, 0.1, 0.15, 0.2),
                          "kelly_ratio" = c(1, 0.5, 0.25))) %>%
  as.data.frame() %>%
  mutate(kelly_c = 
           coalesce(ifelse(pred_res == "Over 2.5", 
                           0.5 * ((pred_prob * odds_251 - 1)/(odds_251 - 1)), 
                           0.5 * ((pred_prob * odds_25 - 1)/(odds_25 - 1))), 0)) %>%
  mutate(n_goals_cat = ifelse(total_goals > 2.5, "Over 2.5", "Under_2.5")) %>%
  mutate(b_return = coalesce(ifelse(prob_over > prob_under, odds_251, odds_25), 0)) %>%
  mutate(kelly_bet_return = 
           ifelse(kelly_c >= min_kelly, kelly_c * kelly_ratio * 5000, 0) *
           ifelse(n_goals_cat == pred_res, b_return, - 1))

write.xlsx(x = eval_masterdata %>%
             group_by(data_type, season, model_name, min_kelly, kelly_ratio) %>%
             filter(!is.na(kelly_c) & !is.infinite(kelly_c)) %>%
             summarise(t_match = n(),
                       t_b_match = sum(kelly_bet_return != 0),
                       return = 
                         coalesce(sum(kelly_bet_return)/(sum(kelly_bet_return != 0) * 5000), 0)) %>%
             as.data.frame(), 
           file = output_file, 
           sheetName = "Results", 
           row.names = F)

rm(list = ls()[!(ls() %in% c("glm_m_final", "hurdle_model"))])

save.image("C:/Users/Peter/Desktop/ds_projects/betting_data_science/6 glm models/1 model development/preliminary_data/glm_models.RData")
```