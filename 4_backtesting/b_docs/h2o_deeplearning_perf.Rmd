---
title: "Performance Evaluation of H2O Deep Learning Model"
author: "Ing. Peter Tomko, M.A."
date: "16/4/2020"
output: html_document
runtime: shiny
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(data.table)
library(tidyr)
library(purrr)
library(ggplot2)

load("C:/Users/Peter/Desktop/ds_projects/betting_data_science/4_backtesting/db_temp/b_h2o_deeplearning.RData")
```

## Adding Time Dimension
```{r Time Index}
backtesting_output <- 
  backtesting_output %>%
  rowwise() %>%
  
  # - calculate time index (distinct part at which the one round of matches is executed)
  mutate(time_index = 
           as.numeric(stringr::str_split(season, "/")[[1]][1]) + 
           as.numeric(stringr::str_split(season, "/")[[1]][2]) + 
           round/200) %>%
  as.data.frame() %>%
  
  # - create time index for each league
  group_by(Div) %>%
  arrange(time_index) %>%
  mutate(t_id = row_number()) %>%
  as.data.frame() %>%
  select(-time_index)
```

## Cumulative Accuracy

```{r Cumulative Accuracy}
cum_accuracy <- backtesting_output %>%
  filter(payoff_type %in% "payoff_B365") %>%
  group_by(Div, t_id) %>%
  mutate(metric_data = map(res_opt_data, function(df_input){
    temp_data <- df_input
    
    return(data.frame("tot_n" = nrow(temp_data),
                      "tot_good" = nrow(temp_data %>% 
                                          filter(goals_result == my_pred_result))))
  })) %>%
  
  select(Div, season, round, t_id, metric_data) %>%
  unnest(c(metric_data)) %>%
  group_by(Div) %>%
  arrange(t_id) %>%
  mutate(c_tot_n = cumsum(tot_n),
         c_tot_good = cumsum(tot_good))

for(i in unique(cum_accuracy$Div)){
  print(ggplot(data = cum_accuracy %>% filter(Div %in% i)) +
          geom_line(aes(x = t_id, y = c_tot_good/c_tot_n)) +
          facet_grid(Div ~ .) +
          ggtitle("Cumulative Accuracy, i.e. c_tot_good/c_tot_n") +
          xlab("Round") +
          ylab("c_tot_good/c_tot_n"))
}

rm(cum_accuracy)
```

## Betting Strategy Evaluation
```{r Betting Strategy Evaluation}
init_cap <- 50000
bet_strategy <- backtesting_output %>%
  group_by(Div, t_id, payoff_type) %>%
  mutate(metric_data = map(res_opt_data, function(df_input){
    
    temp_data <- df_input %>%
      rowwise() %>%
      mutate(is_win = ifelse(goals_result == my_pred_result, 
                             yes = coalesce(payoff - 1, 0) * o_fr, 
                             no = -1 * o_fr)) %>%
      
      select(HomeTeam, AwayTeam, is_win)
    
    return(temp_data)
    
  })) %>%
  select(Div, t_id, metric_data, payoff_type) %>%
  unnest(c(metric_data)) %>%
  
  group_by(Div, payoff_type) %>%
  nest() %>%
  
  mutate(profit_calc = map(data, function(df_input){
    d_temp <- df_input %>%
      arrange(t_id)
    
    # d_temp <- bet_strategy$data[[1]] %>%
    #   arrange(t_id)
    d_temp[is.na(d_temp)] <- 0
    
    profit_data <- 
      data.frame("t_id" = rep(0, length(unique(d_temp$t_id))),
                 "c_profit" = rep(0, length(unique(d_temp$t_id))))
    
    c_it <- 1
    for(i in unique(d_temp$t_id)){
      
      profit_data$t_id[c_it] <- i
      
      if(c_it == 1){
        
        profit_data$c_profit[c_it] <- 
          init_cap + sum(init_cap * d_temp$is_win[d_temp$t_id == i])
        
      }else{
        
        profit_data$c_profit[c_it] <- 
          profit_data$c_profit[c_it - 1] +
          sum(init_cap * d_temp$is_win[d_temp$t_id == i])
        
      }
      
      c_it <- c_it + 1
    }
    
    return(profit_data)
  })) %>%
  
  select(-data) %>%
  unnest(c(profit_calc)) %>%
  as.data.frame()

for(i in unique(bet_strategy$Div)){
  print(ggplot(data = bet_strategy %>% filter(Div %in% i)) +
          geom_line(aes(x = t_id, y = c_profit, colour = payoff_type)) +
          facet_grid(Div ~ .) +
          ggtitle("Cum Betting Profit - Dynamic Strategy") +
          xlab("Round") +
          ylab("Profit"))
}
```