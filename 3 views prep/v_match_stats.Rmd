---
title: "3 Views Prep"
author: "Ing. Peter Tomko, M.A."
date: "28/8/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include = T, warning = F, message = F, error = T}
knitr::opts_chunk$set(echo = TRUE)

library(DBI)
library(data.table)
library(dplyr)
```

## Creating Input Data Set for Modelling Stage - `v_match_stats`

The data created helps to compute the data, i.e. KPI metrics, that will be used in the modeling stage. Two tables necessary at this step - `v_match_stats` containing the basic static KPIs for each match (for example number of goals, number of red cards, number of shots)  and `v_last_matches` containing the information about `n-` last matches to each match in database (i.e. `n` in `(5, 10, 15, ... , 50)`).

Note:

This step is rather work around, because what I am doing is that there needs to be performed inequality left join. To each match date, the historical matches are joined in order to compute windowed statistics (might end up with some big table which I was able to compute within my available hardware).

### Establish Connection
```{r connection, warning = F, message = F, error = F}
con <- DBI::dbConnect(odbc::odbc(), "betting_ds", bigint = "integer")
```

### Get Match Statistics

The logic of the view is to calculate for each `season`, `league`, `created_at`, `team`, `is_home` and `match_id` following numerical variables `total_goals` (total number of goals in a match), `match_results` (result of the match, i.e. `H`, `D`, `A`), `n_goals` (number of goals in the match by either a `HomeTeam` or `AwayTeam`), `n_shots`, `n_shots_ontarget`, `n_fauls`, `n_corners`, `n_yellow_cards`, `n_red_cards` (number of shots, shots on target, fouls, corners, yellow cards and red cards by a team during the match). Following are same ratio variables `r_shots_goals`, `r_st_goals`, `r_fauls_goals`, `r_corners_goals`, `r_yellow_cards`, `r_red_Cards` (ratio of shots - shots on target, fouls, corners, yellow cards, red cards; to goals by a team during the match). `r_team_odds` and `r_draw_odds` are created by using coalescing function over the bookmakers odds columns (B365, BW etc.). Additional columns are derived from the cumulative match results - I assigned 3 points for `win`, 0 for `loss` and 1 for `draw`, afterwards the cumulative sums are created for following variables - `o_strength_ah` (cumulative strength for `Home` and `Away` matches, i.e. indicator how the team is performing in `Home` and `Away` matches), `o_strength` (cumulative strength of team without considering where they play), `o_strength_season` (same as `o_strength` but the indication is related to current season), `o_strength_season_ah` (same as `o_strength_ah` but considering the current season).

```{sql Drop Match Stats, connection = con, warning = F, message = F, error = T}
drop view if exists v_match_stats;
```

```{sql Match Stats, connection = con, warning = F, message = F, error = T}
create view v_match_stats as (

select season, league, created_at, team, is_home, match_id, match_results, 
total_goals, n_goals, n_shots, n_shots_ontarget, n_fauls, n_corners, 
n_yellow_cards, n_red_cards, r_shots_goals, r_st_goals, r_fauls_goals, 
r_corners_goals, r_yellow_goals, r_red_goals, r_team_odds, r_draw_odds,

sum(match_results_n) over(partition by team, league, is_home order by created_at asc) as o_strength_ah,
sum(match_results_n) over(partition by team, league order by created_at asc) as o_strength,
sum(match_results_n) over(partition by team, league, season order by created_at asc) as o_strength_season,
sum(match_results_n) over(partition by team, league, season, is_home order by created_at asc) as o_strength_season_ah

from
(select 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, match_id, 
fthg + ftag as total_goals,

case 
when ftr = 'H' and is_home = 1 then 1
when ftr = 'A' and is_home = 0 then 1
when ftr = 'A' and is_home = 1 then 0
when ftr = 'H' and is_home = 0 then 0
else -1 end as match_results,

case 
when ftr = 'H' and is_home = 1 then 3
when ftr = 'A' and is_home = 0 then 3
when ftr = 'A' and is_home = 1 then 0
when ftr = 'H' and is_home = 0 then 0
else 1 end as match_results_n,

case when is_home = 1 then fthg else ftag end as n_goals,
case when is_home = 1 then hs else "as" end as n_shots,
case when is_home = 1 then hst else ast end as n_shots_ontarget,
case when is_home = 1 then hf else af end as n_fauls,
case when is_home = 1 then hc else ac end as n_corners,
case when is_home = 1 then hy else ay end as n_yellow_cards,
case when is_home = 1 then hr else ar end as n_red_cards,

case when is_home = 1 then hs/(fthg + 1) else "as"/(ftag + 1) end as r_shots_goals,
case when is_home = 1 then hst/(fthg + 1) else ast/(ftag + 1) end as r_st_goals,
case when is_home = 1 then hf/(fthg + 1) else af/(ftag + 1) end as r_fauls_goals,
case when is_home = 1 then hc/(fthg + 1) else ac/(ftag + 1) end as r_corners_goals,
case when is_home = 1 then hy/(fthg + 1) else ay/(ftag + 1) end as r_yellow_goals,
case when is_home = 1 then hr/(fthg + 1) else ar/(ftag + 1) end as r_red_goals,

case when is_home = 1 then coalesce(b365h, bwh, iwh, psh, whh, vch) 
else coalesce(b365a, bwa, iwa, psa, wha, vca) end as r_team_odds,
coalesce(b365d, bwd, iwd, psd, whd, vcd) as r_draw_odds

from t_match_stats) as m_data);
```

### Historical Matches

The important part, as discussed in the opening paragraph, is to get for each match `n` previous matches, in order to obtain variables for the modelling stage. Eventually, for each match we will obtain variables like `n_shots__last_5` (average number of shots in the 5 previous matches), `n_shots__last_10`, ... , `n_shots__last_50`. Due to a hardware limitation, this is a rather work around, ideal solution would be to join it directly, without making a interim step.

```{sql Drop Last Matches, connection = con, warning = F, message = F, error = T}
drop view if exists v_last_matches;
```

```{sql Last Matches, connection = con, warning = F, message = F, error = T}
create view v_last_matches as (

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 5 preceding and current row) as last_n,
'last_5' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 10 preceding and current row) as last_n,
'last_10' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 15 preceding and current row) as last_n,
'last_15' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 20 preceding and current row) as last_n,
'last_20' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 25 preceding and current row) as last_n,
'last_25' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 30 preceding and current row) as last_n,
'last_30' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 35 preceding and current row) as last_n,
'last_35' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 40 preceding and current row) as last_n,
'last_40' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 45 preceding and current row) as last_n,
'last_45' as hist_category
from t_match_stats

union all

select distinct 
trim(both season) as season, 
trim(both league) as league, 
created_at, 
trim(both team) as team, 
is_home, 
min(created_at) over(partition by team, is_home order by created_at rows between 50 preceding and current row) as last_n,
'last_50' as hist_category
from t_match_stats
);
```
